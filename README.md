Using the DADA2 pipeline for sequence variant identification
============================================================

Here we provide a R Notebook template to generate a sequences variants table from FASTQ files generated by Paired-End Illumina sequencing.
For maximal reproducibility, we also provide a R project file and its associated packrat packages managment directory.

Note: Commands described in this documentation assume that you are using a Unix CLI.

## Resources

* Git clone URL: https://github.com/chuv-pne/dada2.git
* Documentation: https://github.com/chuv-pne/dada2
* DADA2: https://benjjneb.github.io/dada2
* illumina-utils: https://github.com/merenlab/illumina-utils
* docker image with pre-installed environment: https://hub.docker.com/r/chuv-pne/pne-docker

## Rights

* Copyright (c) 2018 Service de Pneumologie, Centre Hospitalier Universitaire Vaudois (CHUV), Switzerland
* License: The R Notebook template (.Rmd) is provided under the MIT license (See LICENSE.txt for details)
* Authors: A. Rapin, C. Pattaroni, B.J. Marsland

## System requirements

* R 3.5.1
* R packrat package
* RStudio
* illumina-utils: <a href="https://github.com/merenlab/illumina-utils" target="_blank">https://github.com/merenlab/illumina-utils</a>
* git

R packages are managed using packrat. This ensures maximal reproducibility and portability of the analysis by using an encapsulated, version controlled, installation of R packages instead of any system-level R packages installation.

Note that additional system requirements as well as dependencies may be necessary for the installation of some R packages, such as dada2.

For maximal reproducibility and easy deployement across machines and platforms, you can use docker containers to run RStudio server and illumina-utils commands. A suitable docker image satisfying all system requirements for using the provided R Notebook template is available at https://hub.docker.com/r/chuv-pne/pne-docker. Instructions are further provided below in the <b>Working on docker</b> section.

## Files

* `R1.fastq.gz`: FASTQ file for the forward read
* `R2.fastq.gz`: FASTQ file for the reverse read
* `Index.fastq.gz`: FASTQ file for the index read
* `barcode_to_sample.txt`: A text file mapping index barcodes to samples

It is assumed that the FASTQ files were archived using gzip.
The `barcode_to_sample.txt` file must contain two tab-delimited columns: the first for samples names and the second for samples barcodes as shown <a href="https://github.com/merenlab/illumina-utils/blob/master/examples/demultiplexing/barcode_to_sample.txt" target="_blank">here</a>. Avoid special characters.

If multiple sequencing runs have to be analyzed together, create a directory for each run and place the respective FASTQ and `barcode_to_sample.txt` files inside.

## Preparation

Get a copy of this repository and set it as your working directory:
```
$ git clone https://github.com/chuv-pne/dada2.git my_project_dir
$ cd my_project_dir
```

Place your FASTQ files and the `barcode_to_sample.txt` file in a directory, then place this directory within the directory named `run_data`.
The final directory structure should look like:
<pre>
my_project_dir
├── <b>run_data</b>
|   └── <b>run01</b>
|       ├── <b>R1.fastq.gz</b>
|       ├── <b>R2.fastq.gz</b>
|       ├── <b>Index.fastq.gz</b>
|       └── <b>barcode_to_sample.txt</b>
├── packrat
|   └── ...
├── README.md
├── LICENSE.txt
└── dada2.Rmd
</pre>

If multiple sequencing runs have to be analyzed together, place each run directory inside the directory named `run_data`.
In this case, the final directory structure should look like:
<pre>
my_project_dir
├── <b>run_data</b>
|   ├── <b>run01</b>
|   |   ├── <b>R1.fastq.gz</b>
|   |   ├── <b>R2.fastq.gz</b>
|   |   ├── <b>Index.fastq.gz</b>
|   |   └── <b>barcode_to_sample.txt</b>
|   ├── <b>run02</b>
|   |   ├── <b>R1.fastq.gz</b>
|   |   ├── <b>R2.fastq.gz</b>
|   |   ├── <b>Index.fastq.gz</b>
|   |   └── <b>barcode_to_sample.txt</b>
.   .
.   .
.   .
|   └── <b>runNN</b>
|       ├── <b>R1.fastq.gz</b>
|       ├── <b>R2.fastq.gz</b>
|       ├── <b>Index.fastq.gz</b>
|       └── <b>barcode_to_sample.txt</b>
├── packrat
|   └── ...
├── README.md
├── LICENSE.txt
└── dada2.Rmd
</pre>

## Usage

After loading the `dada2.Rproj` R project file in RStudio, open the `dada2.Rmd` R Notebook template in RStudio and follow the instructions in the text and comments.

## Working on docker

If not done yet, install docker by following the documentation at https://docs.docker.com/install.

Note: you will have to use sudo with docker commands if docker is not configured to be used as a non-root user. You may have to contact your IT administrator for that.

A docker image satisfying all system requirements for using the provided R Notebook template is available at https://hub.docker.com/r/chuv-pne/pne-docker.
This docker image comes with pre-installed R, RStudio server and illumina-utils. The R packrat package is also pre-installed and all system requirements for the installation and usage of the R dada2 package are met.

Get a copy of the docker image:
```
$ docker pull chuv-pne/pne-docker
```

Run a docker container:
```
# The -v argument is used to give the docker container access to your local project directory.
# Replace "/path/to/my_project_dir" by the right path to your project directory.
$ docker run --rm -v /path/to/my_project_dir:/home/rstudio/project -p 8787:8787 -ti chuv-pne/pne-docker
```

RStudio server is now running within a docker container, access it from a web browser at the address <a href="localhost:8787" target="_blank">"localhost:8787"</a> and login using the following credentials:
* user: rstudio
* password: rstudio

From the Rstudio server web interface, set the `project` directory as your working directory.

You are now ready to work, go back to the <b>Usage</b> section above.
